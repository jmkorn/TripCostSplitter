<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Expense Splitter</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #b91c1c;
      --success: #16a34a;
    }

    /* Dark mode disabled: force light theme */

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px auto;
      max-width: 900px;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
    }

    h1 {
      font-size: 28px;
      margin: 0 0 12px 0;
      letter-spacing: -0.01em;
    }

    h2 {
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 8px;
    }

    section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.04);
    }

    label { display: block; font-weight: 600; margin-top: 8px; }

    input, select, textarea {
      margin-top: 4px;
      padding: 10px 12px;
      font-size: 14px;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text);
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 20%, transparent);
    }

    button {
      margin-top: 4px;
      font-size: 14px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: background-color 140ms ease, box-shadow 140ms ease, border-color 140ms ease, color 140ms ease;
    }

    .btn:hover { background: var(--primary-hover); }
    .btn:focus { box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 20%, transparent); outline: none; }

    .btn-danger { background: var(--danger); }
    .btn-danger:hover { filter: brightness(0.95); }

    .btn-ghost {
      background: transparent;
      color: var(--text);
      border-color: var(--border);
    }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .pill {
      padding: 6px 10px;
      background: color-mix(in srgb, var(--primary) 10%, var(--card-bg));
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      margin-right: 6px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .list { margin-top: 8px; display: flex; flex-wrap: wrap; }

    .muted { color: var(--muted); }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    ul { list-style: none; padding-left: 0; margin: 0; }
    ul li { padding: 6px 0; border-bottom: 1px dashed var(--border); }
    ul li:last-child { border-bottom: 0; }
  /* net list styles removed (net balances now in matrix) */

    code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
  table.expenses { width: 100%; border-collapse: collapse; margin: 4px 0 16px; }
  table.expenses th, table.expenses td { padding: 6px 8px; border-bottom: 1px solid var(--border); font-size: 13px; text-align: left; vertical-align: top; }
  table.expenses th { background: color-mix(in srgb, var(--primary) 8%, var(--card-bg)); font-weight: 600; }
  table.expenses tbody tr:last-child td { border-bottom: 0; }
  table.expenses button.btn { padding: 4px 8px; font-size: 12px; }
  table.transfers { width: 100%; border-collapse: collapse; margin: 4px 0 8px; }
  table.transfers th, table.transfers td { padding: 6px 8px; border-bottom: 1px solid var(--border); font-size: 13px; }
  table.transfers th { background: color-mix(in srgb, var(--primary) 8%, var(--card-bg)); text-align: left; }
  table.transfers tbody tr:last-child td { border-bottom: 0; }
  /* Expense matrix */
  .matrix-container { overflow-x: auto; border: 1px solid var(--border); border-radius: 12px; background: var(--card-bg); box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  table.matrix { border-collapse: separate; border-spacing:0; font-size: 12.5px; min-width: max(760px, 100%); }
  table.matrix th, table.matrix td { padding: 6px 8px; border-bottom: 1px solid var(--border); border-right: 1px solid var(--border); background: #fff; }
  table.matrix th { position: sticky; top:0; z-index:5; background: linear-gradient(#f1f5f9,#e2e8f0); font-weight:600; font-size:12px; text-align:center; }
  table.matrix th.sticky-col, table.matrix td.sticky-col { position: sticky; left:0; z-index:6; background: linear-gradient(#f8fafc,#f1f5f9); font-weight:600; text-align:left; }
  table.matrix td.sticky-col { z-index:4; }
  table.matrix tr:last-child td { border-bottom:0; }
  table.matrix th:last-child, table.matrix td:last-child { border-right:0; }
  .cell-pos { color: var(--success); font-weight:600; }
  .cell-neg { color: var(--danger); font-weight:600; }
  .matrix-header-meta { display:block; font-weight:400; font-size:10px; color: var(--muted); }
  .matrix-col-header { white-space:nowrap; }
  .matrix-delete { cursor:pointer; color: var(--danger); font-weight:600; font-size:11px; margin-left:4px; }
  .matrix-delete:hover { filter:brightness(0.85); }
  .legend { display:flex; gap:16px; font-size:12px; margin:8px 0 4px; color: var(--muted); }
  .legend span { display:inline-flex; align-items:center; gap:4px; }
  .legend .swatch { width:12px; height:12px; border-radius:3px; }
  .swatch-pos { background: color-mix(in srgb, var(--success) 60%, white); border:1px solid color-mix(in srgb, var(--success) 70%, #000); }
  .swatch-neg { background: color-mix(in srgb, var(--danger) 50%, white); border:1px solid color-mix(in srgb, var(--danger) 70%, #000); }
  .matrix-net-col { background: linear-gradient(#f8fafc,#f1f5f9); font-weight:600; }
  .matrix-footer { font-size:11px; color: var(--muted); margin-top:6px; }
  /* Actionable cell hover effect */
  table.matrix td.actionable { transition: background-color 120ms ease, opacity 120ms ease; }
  table.matrix td.actionable:hover { background: color-mix(in srgb, var(--primary) 12%, #fff); opacity: 1 !important; }
  </style>
  <script>
    // In-memory UI state
    window.state = { people: [], expenses: [] };

    async function api(path, options) {
      const res = await fetch(path, { headers: { 'Content-Type': 'application/json' }, ...options });
      if (!res.ok) throw new Error(await res.text());
      return res.json().catch(() => null);
    }

    async function refreshAll() {
      await refreshPeople();
	  await refreshExpenses(); // ensure local expenses up to date
	  await refreshTransfersPreview();
      await refreshTotals();
    }

    async function refreshPeople() {
      const people = await api('/api/people');
      window.peopleCache = people;
      const c = document.getElementById('people');
      c.innerHTML = '';
      people.forEach(p => {
        const wrapper = document.createElement('span');
        wrapper.className = 'pill';
        wrapper.style.display = 'inline-flex';
        wrapper.style.alignItems = 'center';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = p;
        const del = document.createElement('button');
        del.textContent = 'âœ•';
        del.title = 'Remove person';
        del.style.marginLeft = '6px';
        del.style.background = 'transparent';
        del.style.border = 'none';
        del.style.cursor = 'pointer';
        del.style.color = '#b91c1c';
        del.onclick = async () => { if (confirm('Remove person ' + p + ' and their related expenses?')) { await api('/api/people/' + encodeURIComponent(p), { method: 'DELETE' }); await refreshAll(); } };
        wrapper.appendChild(nameSpan);
        wrapper.appendChild(del);
        c.appendChild(wrapper);
      });
      const payer = document.getElementById('payer');
      payer.innerHTML = '';
      people.forEach(p => {
        const o1 = document.createElement('option'); o1.value = p; o1.textContent = p; payer.appendChild(o1);
      });
      payer.onchange = rebuildParticipantsOptions;
      rebuildParticipantsOptions();
      // Sync local state people with server people
      window.state.people = [...people];
    }

  function rebuildParticipantsOptions() { /* no-op after removal of manual participants select */ }

  // renderLocalNet removed (net balances displayed within matrix now)

    function computeLocalNet(people, expenses) {
      const net = new Map();
      people.forEach(p => net.set(p, 0));
      for (const e of expenses) {
        const participants = Array.from(new Set([...(e.participants || []), e.payer]));
        const shares = allocateShares(e.amount, participants);
        net.set(e.payer, (net.get(e.payer) || 0) + e.amount);
        for (const [person, share] of shares.entries()) {
          net.set(person, (net.get(person) || 0) - share);
        }
      }
      return people.map(name => ({ name, net: round2(net.get(name) || 0) }));
    }

    function allocateShares(totalAmount, participants) {
      const totalCents = decimalToCents(totalAmount);
      const count = participants.length;
      if (count <= 0) return new Map();
      const basePerPerson = Math.floor(totalCents / count);
      let remainder = totalCents - (basePerPerson * count);
      const baseCentsByPerson = new Map();
      for (const p of participants) baseCentsByPerson.set(p, basePerPerson);
      // Distribute remaining cents deterministically by participant order
      for (let i = 0; i < remainder; i++) {
        const person = participants[i % participants.length];
        baseCentsByPerson.set(person, baseCentsByPerson.get(person) + 1);
      }
      const shares = new Map();
      for (const p of participants) {
        shares.set(p, centsToDecimal(baseCentsByPerson.get(p)));
      }
      return shares;
    }

    function decimalToCents(amount) { return Math.round(Number(amount) * 100); }
    function centsToDecimal(cents) { return cents / 100; }
    function round2(x) { return Math.round(x * 100) / 100; }

    async function refreshTransfersPreview() {
      const transfers = await api('/api/settle');
      const tbody = document.getElementById('settleBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!transfers || transfers.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan = 3; td.className = 'muted'; td.textContent = 'No transfers needed.';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }
      transfers.forEach(t => {
        const tr = document.createElement('tr');
        const tdFrom = document.createElement('td'); tdFrom.textContent = t.from;
        const tdTo = document.createElement('td'); tdTo.textContent = t.to;
        const tdAmt = document.createElement('td'); tdAmt.textContent = t.amount.toLocaleString(undefined, { style: 'currency', currency: 'USD' }); tdAmt.style.fontWeight = '600';
        tr.appendChild(tdFrom); tr.appendChild(tdTo); tr.appendChild(tdAmt);
        tbody.appendChild(tr);
      });
    }

    async function addPerson(ev) {
      ev.preventDefault();
      const name = document.getElementById('personName').value.trim();
      if (!name) return;
      await api('/api/people', { method: 'POST', body: JSON.stringify({ name }) });
      document.getElementById('personName').value = '';
      // Update local state
      if (!window.state.people.includes(name)) window.state.people.push(name);
      await refreshPeople();
  // net balances recalculated implicitly in matrix
    }

  function getSelectedParticipants() { return (window.peopleCache || []).slice(); }

    async function addExpense(ev) {
      ev.preventDefault();
      const description = document.getElementById('desc').value.trim();
      const amount = Number(document.getElementById('amount').value);
      const payer = document.getElementById('payer').value;
      const participants = getSelectedParticipants();
      if (!description || !isFinite(amount) || amount <= 0 || !payer) {
        alert('Please fill description, positive amount, and payer.');
        return;
      }
      await api('/api/expenses', { method: 'POST', body: JSON.stringify({ description, amount, payer, participants }) });
      // Update local state and recompute
      window.state.expenses.push({ description, amount, payer, participants });
      document.getElementById('desc').value = '';
      document.getElementById('amount').value = '';
  // net balances recalculated implicitly in matrix
      await refreshTransfersPreview();
  await refreshExpenses();
  await refreshTotals();
    }

    async function resetAll() {
      await api('/api/reset', { method: 'POST' });
      window.state = { people: [], expenses: [] };
      await refreshAll();
    }

    async function refreshExpenses() {
      const list = await api('/api/expenses');
      const byPayer = {};
      list.forEach(e => {
        byPayer[e.payer] = byPayer[e.payer] || [];
        byPayer[e.payer].push(e);
      });
  // sync local state to allow accurate client-side net recomputation
  window.state.expenses = list.map(e => ({ description: e.description, amount: e.amount, payer: e.payer, participants: e.participants }));
      buildExpenseMatrix(list);
    }

    function buildExpenseMatrix(expenses) {
      const container = document.getElementById('expenseMatrixContainer');
      if (!container) return;
      const people = [...window.state.people];
      container.innerHTML = '';
      if (expenses.length === 0 || people.length === 0) {
        container.innerHTML = '<div class="muted">No data â€“ add some people and expenses.</div>';
        return;
      }
      // Build matrix data
      // Pre-compute shares per expense
      const matrixCols = expenses.map((e, idx) => {
        const participants = Array.from(new Set([...(e.participants||[]), e.payer]));
        const shares = allocateShares(e.amount, participants);
        return { index: idx+1, id: e.id, description: e.description, payer: e.payer, amount: e.amount, participants, shares };
      });

      const table = document.createElement('table');
      table.className = 'matrix';
      const thead = document.createElement('thead');
      const headerRow = document.createElement('tr');
      // First corner cell
      const corner = document.createElement('th'); corner.className='sticky-col'; corner.textContent='Person'; headerRow.appendChild(corner);
      matrixCols.forEach(col => {
        const th = document.createElement('th'); th.className='matrix-col-header';
        const title = document.createElement('span'); title.textContent = col.description || '(Untitled)';
        const meta = document.createElement('span'); meta.className='matrix-header-meta'; meta.textContent = `${col.payer} â€¢ ${col.amount.toLocaleString(undefined,{style:'currency',currency:'USD'})}`;
        th.appendChild(title); th.appendChild(meta);
        const del = document.createElement('span'); del.textContent='âœ•'; del.className='matrix-delete'; del.title='Delete expense';
        del.onclick = async () => { if (confirm('Delete this expense?')) { await api('/api/expenses/' + col.id, { method: 'DELETE' }); await refreshAll(); } };
        th.appendChild(del);
        headerRow.appendChild(th);
      });
      const netTh = document.createElement('th'); netTh.textContent='Net'; netTh.className='matrix-col-header'; headerRow.appendChild(netTh);
      thead.appendChild(headerRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      // Precompute net balances (client side for speed)
  const nets = computeLocalNet(people, window.state.expenses);
      const netMap = new Map(nets.map(n => [n.name, n.net]));
      people.forEach(person => {
        const tr = document.createElement('tr');
        const nameTd = document.createElement('td'); nameTd.textContent = person; nameTd.className='sticky-col'; tr.appendChild(nameTd);
        matrixCols.forEach(col => {
          const td = document.createElement('td');
          td.dataset.expenseId = col.id;
          td.dataset.person = person;
          const isPayer = person === col.payer;
          const isParticipant = col.participants.includes(person);
          if (isPayer) {
            td.textContent = '+' + col.amount.toLocaleString(undefined,{style:'currency',currency:'USD'});
            td.className='cell-pos';
            td.title = 'Payer (cannot toggle)';
          } else if (isParticipant) {
            const share = col.shares.get(person) || 0;
            td.textContent = '-' + share.toLocaleString(undefined,{style:'currency',currency:'USD'});
            td.className='cell-neg actionable';
            td.title = 'Click to remove this person from the expense';
            td.style.cursor = 'pointer';
            td.onclick = () => toggleParticipation(col.id, person, false);
          } else {
            td.textContent = '0';
            td.style.opacity = 0.35;
            td.title = 'Click to include this person';
            td.style.cursor = 'pointer';
            td.classList.add('actionable');
            td.onclick = () => toggleParticipation(col.id, person, true);
          }
          tr.appendChild(td);
        });
        const netTd = document.createElement('td');
        const netVal = netMap.get(person) || 0;
        const sign = netVal >=0 ? '+' : '';
        netTd.textContent = sign + netVal.toLocaleString(undefined,{style:'currency',currency:'USD'});
        netTd.className = 'matrix-net-col ' + (netVal>=0? 'cell-pos':'cell-neg');
        tr.appendChild(netTd);
        tbody.appendChild(tr);
      });
      table.appendChild(tbody);
      container.appendChild(table);
      const footer = document.createElement('div'); footer.className='matrix-footer'; footer.textContent='Positive cells show who paid an expense; negative cells show each participant\'s share owed. Net column matches current balances.';
      container.appendChild(footer);
    }

    async function importPeopleFromFile(ev) {
      const fileInput = document.getElementById('peopleFile');
      const file = fileInput.files[0];
      if (!file) return;
      const text = await file.text();
      await fetch('/api/people/import', { method: 'POST', body: text });
      fileInput.value = '';
      await refreshAll();
    }

    async function refreshTotals() {
      const totals = await api('/api/totals');
      const c = document.getElementById('totals');
      if (!c) return;
      c.innerHTML = '';
      totals.forEach(t => {
        const li = document.createElement('li');
        li.textContent = `${t.name}: ${t.spent.toLocaleString(undefined,{style:'currency',currency:'USD'})}`;
        c.appendChild(li);
      });
    }

    async function toggleParticipation(expenseId, person, include) {
      try {
        // Find existing expense participants from state
        const full = await api('/api/expenses');
        const exp = full.find(e => e.id === expenseId);
        if (!exp) return;
        let participants = Array.from(new Set([...(exp.participants||[])]));
        if (include) {
          if (!participants.includes(person)) participants.push(person);
        } else {
          participants = participants.filter(p => p !== person);
        }
        // Ensure we don't remove payer
        if (!participants.includes(exp.payer)) participants.push(exp.payer);
        await api(`/api/expenses/${expenseId}/participants`, { method: 'POST', body: JSON.stringify({ participants }) });
        await refreshAll();
      } catch (err) {
        console.error(err);
        alert('Failed to update participation: ' + err);
      }
    }

    async function generateExplanation() {
      const panel = document.getElementById('explanationPanel');
      const loading = document.getElementById('explanationLoading');
      const content = document.getElementById('explanationContent');
      const promptEl = document.getElementById('explanationPrompt');
      panel.style.display = 'block';
      loading.style.display = 'block';
      content.textContent = '';
      promptEl.textContent = '';
      try {
        const res = await api('/api/explain');
        loading.style.display = 'none';
        content.textContent = res.explanation || '(No explanation returned)';
        promptEl.textContent = res.prompt || '';
        if (res.usedLLM === false) {
          content.innerHTML = '<strong style="color:#b45309;">(AI not configured / fallback)</strong>\n' + content.textContent;
        }
      } catch (err) {
        loading.style.display = 'none';
        content.textContent = 'Failed to get explanation: ' + err;
      }
    }

    window.addEventListener('DOMContentLoaded', refreshAll);
  </script>
</head>
<body>
  <h1>Expense Splitter</h1>
  <p class="muted" style="margin-top: -6px; margin-bottom: 16px;">Split trip expenses quickly.</p>

  <section>
    <div class="actions">
      <form onsubmit="addPerson(event)">
        <label>Add person</label>
        <div class="row">
          <input id="personName" placeholder="Name" />
          <button type="submit" class="btn">Add</button>
          <button type="button" onclick="resetAll()" class="btn btn-danger">Reset</button>
        </div>
      </form>
    </div>
    <div style="margin-top:12px;">
      <label>Import people from file (comma, semicolon, or newline separated)</label>
      <input type="file" id="peopleFile" accept="text/plain" />
      <button type="button" class="btn" onclick="importPeopleFromFile()">Import</button>
    </div>
    <div id="people" class="list"></div>
  </section>

  <section id="matrixSection">
    <h2 style="display:flex;align-items:center;gap:12px; margin-bottom:12px;">Expense Matrix <span class="muted" style="font-size:12px;font-weight:400;">(people vs. transactions â€“ click a cell to toggle participation)</span></h2>
    <form onsubmit="addExpense(event)" style="margin-bottom:12px;">
      <div class="row" style="align-items:flex-end; gap:12px; flex-wrap:wrap;">
        <div style="flex:2 1 240px;">
          <label style="margin-top:0;">Description</label>
          <input id="desc" placeholder="Dinner, Gas, Hotel..." />
        </div>
        <div style="flex:1 1 140px;">
          <label style="margin-top:0;">Amount</label>
          <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" />
        </div>
        <div style="flex:1 1 180px;">
          <label style="margin-top:0;">Payer</label>
          <select id="payer"></select>
        </div>
        <div style="flex:0 0 auto; padding-top:22px;">
          <button type="submit" class="btn">Add expense</button>
        </div>
      </div>
      <div class="muted" style="font-size:12px; margin-top:4px;">All people are included by default; remove participants by clicking cells below.</div>
    </form>
    <div class="legend">
      <span><span class="swatch swatch-pos"></span> Payer amount (+)</span>
      <span><span class="swatch swatch-neg"></span> Participant share (-)</span>
      <span style="font-size:11px;">Click a 0 to include a person; click a negative share to remove them.</span>
    </div>
    <div id="expenseMatrixContainer" class="matrix-container"></div>
  </section>

  <section>
    <h2>Suggested transfers</h2>
    <table class="transfers">
      <thead>
        <tr><th>From</th><th>To</th><th>Amount</th></tr>
      </thead>
      <tbody id="settleBody"></tbody>
    </table>
    <div style="display:flex; align-items:center; gap:12px; flex-wrap:wrap; margin-top:4px;">
      <div class="muted">This is a live preview based on current balances.</div>
      <button type="button" class="btn" id="explainBtn" onclick="generateExplanation()">Explain this</button>
    </div>
    <div id="explanationPanel" style="display:none; margin-top:12px; border:1px solid var(--border); padding:12px; border-radius:10px; background:#f1f5f9;">
      <div id="explanationLoading" class="muted" style="display:none;">Generating explanationâ€¦</div>
      <div id="explanationContent" style="white-space:pre-wrap; font-size:13px; line-height:1.45;"></div>
      <details style="margin-top:8px;">
        <summary style="cursor:pointer; font-size:12px;">Show prompt</summary>
        <pre id="explanationPrompt" style="white-space:pre-wrap; font-size:11px; background:#fff; padding:8px; border:1px solid var(--border); border-radius:6px; overflow:auto; max-height:200px;"></pre>
      </details>
    </div>
  </section>

  <section>
    <h2>Totals spent per person</h2>
    <ul id="totals"></ul>
  </section>
  
  <section>
    <h2>Export</h2>
    <button type="button" class="btn" onclick="window.location='/api/export/excel'">Export to Excel</button>
  <div class="muted" style="margin-top:8px;">Downloads an .xlsx with people, totals, expenses, transfers, and matrix (including per-person net).</div>
  </section>

</body>
</html>


