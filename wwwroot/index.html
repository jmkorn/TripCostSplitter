<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Expense Splitter</title>
  <style>
    :root {
      --bg: #f8fafc;
      --card-bg: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #64748b;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #b91c1c;
      --success: #16a34a;
    }

    /* Dark mode disabled: force light theme */

    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 24px auto;
      max-width: 900px;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
    }

    h1 {
      font-size: 28px;
      margin: 0 0 12px 0;
      letter-spacing: -0.01em;
    }

    h2 {
      font-size: 18px;
      margin-top: 0;
      margin-bottom: 8px;
    }

    section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04), 0 8px 24px rgba(0,0,0,0.04);
    }

    label { display: block; font-weight: 600; margin-top: 8px; }

    input, select, textarea {
      margin-top: 4px;
      padding: 10px 12px;
      font-size: 14px;
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: var(--card-bg);
      color: var(--text);
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 20%, transparent);
    }

    button {
      margin-top: 4px;
      font-size: 14px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 10px;
      border: 1px solid transparent;
      background: var(--primary);
      color: #fff;
      cursor: pointer;
      transition: background-color 140ms ease, box-shadow 140ms ease, border-color 140ms ease, color 140ms ease;
    }

    .btn:hover { background: var(--primary-hover); }
    .btn:focus { box-shadow: 0 0 0 4px color-mix(in srgb, var(--primary) 20%, transparent); outline: none; }

    .btn-danger { background: var(--danger); }
    .btn-danger:hover { filter: brightness(0.95); }

    .btn-ghost {
      background: transparent;
      color: var(--text);
      border-color: var(--border);
    }

    .row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }

    .pill {
      padding: 6px 10px;
      background: color-mix(in srgb, var(--primary) 10%, var(--card-bg));
      color: var(--text);
      border-radius: 999px;
      border: 1px solid var(--border);
      margin-right: 6px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    .list { margin-top: 8px; display: flex; flex-wrap: wrap; }

    .muted { color: var(--muted); }

    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
    .actions { display: flex; gap: 8px; flex-wrap: wrap; }

    ul { list-style: none; padding-left: 0; margin: 0; }
    ul li { padding: 6px 0; border-bottom: 1px dashed var(--border); }
    ul li:last-child { border-bottom: 0; }
    #net li.pos { color: var(--success); font-weight: 600; }
    #net li.neg { color: var(--danger); font-weight: 600; }

    code { background: #f3f4f6; padding: 2px 6px; border-radius: 4px; }
  table.expenses { width: 100%; border-collapse: collapse; margin: 4px 0 16px; }
  table.expenses th, table.expenses td { padding: 6px 8px; border-bottom: 1px solid var(--border); font-size: 13px; text-align: left; vertical-align: top; }
  table.expenses th { background: color-mix(in srgb, var(--primary) 8%, var(--card-bg)); font-weight: 600; }
  table.expenses tbody tr:last-child td { border-bottom: 0; }
  table.expenses button.btn { padding: 4px 8px; font-size: 12px; }
  table.transfers { width: 100%; border-collapse: collapse; margin: 4px 0 8px; }
  table.transfers th, table.transfers td { padding: 6px 8px; border-bottom: 1px solid var(--border); font-size: 13px; }
  table.transfers th { background: color-mix(in srgb, var(--primary) 8%, var(--card-bg)); text-align: left; }
  table.transfers tbody tr:last-child td { border-bottom: 0; }
  table.balances, table.totals { width:100%; border-collapse: collapse; margin:4px 0 8px; }
  table.balances th, table.balances td, table.totals th, table.totals td { padding:6px 8px; border-bottom:1px solid var(--border); font-size:13px; text-align:left; }
  table.balances th, table.totals th { background: color-mix(in srgb, var(--primary) 8%, var(--card-bg)); }
  table.balances tbody tr:last-child td, table.totals tbody tr:last-child td { border-bottom:0; }
  table.balances td.pos, table.totals td.pos { color: var(--success); font-weight:600; }
  table.balances td.neg { color: var(--danger); font-weight:600; }
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
  .modal { background:var(--card-bg); padding:20px; border-radius:12px; max-width:600px; width:100%; box-shadow:0 10px 30px rgba(0,0,0,0.2); }
  .modal h3 { margin-top:0; }
  .modal pre { background:#f3f4f6; padding:12px; border-radius:8px; max-height:260px; overflow:auto; font-size:12px; }
  </style>
  <script>
    // In-memory UI state
    window.state = { people: [], expenses: [] };

    async function api(path, options) {
      const res = await fetch(path, { headers: { 'Content-Type': 'application/json' }, ...options });
      if (!res.ok) throw new Error(await res.text());
      return res.json().catch(() => null);
    }

    async function refreshAll() {
      await refreshPeople();
      await refreshExpenses(); // ensure local expenses up to date
      await refreshTransfersPreview();
      await renderLocalNet(); // compute net after syncing expenses
      await refreshExpenses();
      await refreshTotals();
    }

    async function refreshPeople() {
      const people = await api('/api/people');
      window.peopleCache = people;
      const c = document.getElementById('people');
      c.innerHTML = '';
      people.forEach(p => {
        const wrapper = document.createElement('span');
        wrapper.className = 'pill';
        wrapper.style.display = 'inline-flex';
        wrapper.style.alignItems = 'center';
        const nameSpan = document.createElement('span');
        nameSpan.textContent = p;
        const del = document.createElement('button');
        del.textContent = 'âœ•';
        del.title = 'Remove person';
        del.style.marginLeft = '6px';
        del.style.background = 'transparent';
        del.style.border = 'none';
        del.style.cursor = 'pointer';
        del.style.color = '#b91c1c';
        del.onclick = async () => { if (confirm('Remove person ' + p + ' and their related expenses?')) { await api('/api/people/' + encodeURIComponent(p), { method: 'DELETE' }); await refreshAll(); } };
        wrapper.appendChild(nameSpan);
        wrapper.appendChild(del);
        c.appendChild(wrapper);
      });
      const payer = document.getElementById('payer');
      payer.innerHTML = '';
      people.forEach(p => {
        const o1 = document.createElement('option'); o1.value = p; o1.textContent = p; payer.appendChild(o1);
      });
      payer.onchange = rebuildParticipantsOptions;
      rebuildParticipantsOptions();
      // Sync local state people with server people
      window.state.people = [...people];
    }

    function rebuildParticipantsOptions() {
      const payer = document.getElementById('payer').value;
      const participants = document.getElementById('participants');
      participants.innerHTML = '';
      (window.peopleCache || []).forEach(p => {
        if (p === payer) return; // exclude payer; they are auto-included
        const o2 = document.createElement('option'); o2.value = p; o2.textContent = p; participants.appendChild(o2);
      });
    }

    async function renderLocalNet() {
      let net;
      if ((window.state.expenses || []).length === 0) {
        net = await api('/api/net');
      } else {
        net = computeLocalNet(window.state.people, window.state.expenses);
      }
      const tbody = document.getElementById('netBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      net.forEach(x => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.textContent = x.name;
        const tdNet = document.createElement('td');
        const sign = x.net >= 0 ? '+' : '';
        tdNet.textContent = sign + x.net.toLocaleString(undefined, { style: 'currency', currency: 'USD' });
        tdNet.className = x.net >= 0 ? 'pos' : 'neg';
        tr.appendChild(tdName); tr.appendChild(tdNet);
        tbody.appendChild(tr);
      });
    }

    function computeLocalNet(people, expenses) {
      const net = new Map();
      people.forEach(p => net.set(p, 0));
      for (const e of expenses) {
        const participants = Array.from(new Set([...(e.participants || []), e.payer]));
        const shares = allocateShares(e.amount, participants);
        net.set(e.payer, (net.get(e.payer) || 0) + e.amount);
        for (const [person, share] of shares.entries()) {
          net.set(person, (net.get(person) || 0) - share);
        }
      }
      return people.map(name => ({ name, net: round2(net.get(name) || 0) }));
    }

    function allocateShares(totalAmount, participants) {
      const totalCents = decimalToCents(totalAmount);
      const count = participants.length;
      if (count <= 0) return new Map();
      const basePerPerson = Math.floor(totalCents / count);
      let remainder = totalCents - (basePerPerson * count);
      const baseCentsByPerson = new Map();
      for (const p of participants) baseCentsByPerson.set(p, basePerPerson);
      // Distribute remaining cents deterministically by participant order
      for (let i = 0; i < remainder; i++) {
        const person = participants[i % participants.length];
        baseCentsByPerson.set(person, baseCentsByPerson.get(person) + 1);
      }
      const shares = new Map();
      for (const p of participants) {
        shares.set(p, centsToDecimal(baseCentsByPerson.get(p)));
      }
      return shares;
    }

    function decimalToCents(amount) { return Math.round(Number(amount) * 100); }
    function centsToDecimal(cents) { return cents / 100; }
    function round2(x) { return Math.round(x * 100) / 100; }

    async function refreshTransfersPreview() {
      const transfers = await api('/api/settle');
      const tbody = document.getElementById('settleBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      if (!transfers || transfers.length === 0) {
        const tr = document.createElement('tr');
        const td = document.createElement('td'); td.colSpan = 3; td.className = 'muted'; td.textContent = 'No transfers needed.';
        tr.appendChild(td); tbody.appendChild(tr); return;
      }
      transfers.forEach(t => {
        const tr = document.createElement('tr');
        const tdFrom = document.createElement('td'); tdFrom.textContent = t.from;
        const tdTo = document.createElement('td'); tdTo.textContent = t.to;
        const tdAmt = document.createElement('td'); tdAmt.textContent = t.amount.toLocaleString(undefined, { style: 'currency', currency: 'USD' }); 
        tdAmt.style.fontWeight = '600';
        tr.appendChild(tdFrom); tr.appendChild(tdTo); tr.appendChild(tdAmt);
        tbody.appendChild(tr);
      });
    }

    async function addPerson(ev) {
      ev.preventDefault();
      const name = document.getElementById('personName').value.trim();
      if (!name) return;
      await api('/api/people', { method: 'POST', body: JSON.stringify({ name }) });
      document.getElementById('personName').value = '';
      // Update local state
      if (!window.state.people.includes(name)) window.state.people.push(name);
      await refreshPeople();
      await renderLocalNet();
    }

    function getSelectedParticipants() {
      const sel = document.getElementById('participants');
      return Array.from(sel.selectedOptions).map(o => o.value);
    }

    async function addExpense(ev) {
      ev.preventDefault();
      const description = document.getElementById('desc').value.trim();
      const amount = Number(document.getElementById('amount').value);
      const payer = document.getElementById('payer').value;
      const participants = getSelectedParticipants();
      if (!description || !isFinite(amount) || amount <= 0 || !payer || participants.length === 0) {
        alert('Please fill description, positive amount, payer, and at least one participant.');
        return;
      }
      await api('/api/expenses', { method: 'POST', body: JSON.stringify({ description, amount, payer, participants }) });
      // Update local state and recompute
      window.state.expenses.push({ description, amount, payer, participants });
      document.getElementById('desc').value = '';
      document.getElementById('amount').value = '';
      await renderLocalNet();
      await refreshTransfersPreview();
  await refreshExpenses();
  await refreshTotals();
    }

    async function resetAll() {
      await api('/api/reset', { method: 'POST' });
      window.state = { people: [], expenses: [] };
      await refreshAll();
    }

    function closeExplain() {
      const m = document.getElementById('explainModal');
      if (m) m.remove();
    }

    async function explainSettlement() {
      const btn = document.getElementById('explainBtn');
      if (btn) { btn.disabled = true; btn.textContent = 'Generating...'; }
      try {
        const res = await api('/api/explain');
        const backdrop = document.createElement('div'); backdrop.className = 'modal-backdrop'; backdrop.id = 'explainModal';
        const modal = document.createElement('div'); modal.className = 'modal';
        const h = document.createElement('h3'); h.textContent = 'Settlement Explanation'; modal.appendChild(h);
        const p = document.createElement('p'); p.textContent = res.explanation || 'Explanation unavailable.'; modal.appendChild(p);
        const detailsToggle = document.createElement('button'); detailsToggle.className='btn btn-ghost'; detailsToggle.textContent='Show prompt';
        const pre = document.createElement('pre'); pre.style.display='none'; pre.textContent = res.prompt;
        detailsToggle.onclick = () => { pre.style.display = pre.style.display==='none' ? 'block':'none'; detailsToggle.textContent = pre.style.display==='none' ? 'Show prompt':'Hide prompt'; };
        modal.appendChild(detailsToggle);
        modal.appendChild(pre);
        const close = document.createElement('button'); close.className='btn'; close.style.marginTop='12px'; close.textContent='Close'; close.onclick=closeExplain; modal.appendChild(close);
        backdrop.appendChild(modal);
        document.body.appendChild(backdrop);
      } catch (e) { alert('Failed to generate explanation: ' + e); }
      finally { if (btn) { btn.disabled = false; btn.textContent = 'Explain settlement'; } }
    }

    async function refreshExpenses() {
      const list = await api('/api/expenses');
      const byPayer = {};
      list.forEach(e => {
        byPayer[e.payer] = byPayer[e.payer] || [];
        byPayer[e.payer].push(e);
      });
  // sync local state to allow accurate client-side net recomputation
  window.state.expenses = list.map(e => ({ description: e.description, amount: e.amount, payer: e.payer, participants: e.participants }));
      const container = document.getElementById('expenses');
      if (!container) return;
      container.innerHTML = '';
      const payers = Object.keys(byPayer).sort((a,b)=>a.localeCompare(b));
      if (payers.length === 0) { container.innerHTML = '<div class="muted">No expenses yet.</div>'; return; }
      payers.forEach(p => {
        const sec = document.createElement('div');
        const header = document.createElement('h3');
        header.textContent = p;
        header.style.margin = '12px 0 4px';
        sec.appendChild(header);
        const table = document.createElement('table');
        table.className = 'expenses';
        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th style="width:40%">Description</th><th style="width:15%">Amount</th><th>Participants</th><th style="width:90px">Actions</th></tr>';
        table.appendChild(thead);
        const tbody = document.createElement('tbody');
        byPayer[p].forEach(e => {
          const tr = document.createElement('tr');
          const participants = e.participants.join(', ');
          const tdDesc = document.createElement('td'); tdDesc.textContent = e.description;
          const tdAmt = document.createElement('td'); tdAmt.textContent = e.amount.toLocaleString(undefined,{style:'currency',currency:'USD'});
          const tdParts = document.createElement('td'); tdParts.textContent = participants;
          const tdActions = document.createElement('td');
          const del = document.createElement('button');
          del.textContent = 'Delete';
          del.className = 'btn btn-ghost';
          del.onclick = async () => { if (confirm('Delete this expense?')) { await api('/api/expenses/' + e.id, { method: 'DELETE' }); await refreshAll(); } };
          tdActions.appendChild(del);
          tr.appendChild(tdDesc);
          tr.appendChild(tdAmt);
          tr.appendChild(tdParts);
          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        sec.appendChild(table);
        container.appendChild(sec);
      });
    }

    async function importPeopleFromFile(ev) {
      const fileInput = document.getElementById('peopleFile');
      const file = fileInput.files[0];
      if (!file) return;
      const text = await file.text();
      await fetch('/api/people/import', { method: 'POST', body: text });
      fileInput.value = '';
      await refreshAll();
    }

    async function refreshTotals() {
      const totals = await api('/api/totals');
      const tbody = document.getElementById('totalsBody');
      if (!tbody) return;
      tbody.innerHTML = '';
      totals.sort((a,b)=> b.spent - a.spent);
      totals.forEach(t => {
        const tr = document.createElement('tr');
        const tdName = document.createElement('td'); tdName.textContent = t.name;
        const tdAmt = document.createElement('td'); tdAmt.textContent = t.spent.toLocaleString(undefined,{style:'currency',currency:'USD'}); tdAmt.className = 'pos';
        tr.appendChild(tdName); tr.appendChild(tdAmt);
        tbody.appendChild(tr);
      });
    }

    window.addEventListener('DOMContentLoaded', refreshAll);
  </script>
</head>
<body>
  <h1>Expense Splitter</h1>
  <p class="muted" style="margin-top: -6px; margin-bottom: 16px;">Split trip expenses quickly.</p>

  <section>
    <div class="actions">
      <form onsubmit="addPerson(event)">
        <label>Add person</label>
        <div class="row">
          <input id="personName" placeholder="Name" />
          <button type="submit" class="btn">Add</button>
          <button type="button" onclick="resetAll()" class="btn btn-danger">Reset</button>
        </div>
      </form>
    </div>
    <div style="margin-top:12px;">
      <label>Import people from file (comma, semicolon, or newline separated)</label>
      <input type="file" id="peopleFile" accept="text/plain" />
      <button type="button" class="btn" onclick="importPeopleFromFile()">Import</button>
    </div>
    <div id="people" class="list"></div>
  </section>

  <section>
    <form onsubmit="addExpense(event)">
      <label>Description</label>
      <input id="desc" placeholder="Dinner, Gas, Hotel..." />

      <div class="grid">
        <div>
          <label>Amount</label>
          <input id="amount" type="number" step="0.01" min="0" placeholder="0.00" />
        </div>
        <div>
          <label>Payer</label>
          <select id="payer"></select>
        </div>
      </div>

      <label>Participants (multi-select)</label>
      <select id="participants" multiple size="5" style="width: 100%;"></select>
      <div class="muted">Payer is automatically included; select the other people sharing this expense.</div>

      <!-- Weights removed -->

      <div class="actions" style="margin-top: 8px;">
        <button type="submit" class="btn">Add expense</button>
      </div>
      <br>
      <div class="muted">Expenses are split equally among participants.</div>
    </form>
  </section>

  <section>
    <h2>Net balances</h2>
    <table class="balances">
      <thead><tr><th>Name</th><th>Net</th></tr></thead>
      <tbody id="netBody"></tbody>
    </table>
  </section>

  <section>
    <h2>Suggested transfers</h2>
    <table class="transfers">
      <thead>
        <tr><th>From</th><th>To</th><th>Amount</th></tr>
      </thead>
      <tbody id="settleBody"></tbody>
    </table>
    <div class="muted">This is a live preview based on current balances.</div>
    <div style="margin-top:8px;">
      <button id="explainBtn" type="button" class="btn" onclick="explainSettlement()">Explain settlement</button>
    </div>
  </section>

  <section>
    <h2>Totals spent per person</h2>
    <table class="totals">
      <thead><tr><th>Name</th><th>Spent</th></tr></thead>
      <tbody id="totalsBody"></tbody>
    </table>
  </section>
  
  <section>
    <h2>Expenses by payer</h2>
    <div id="expenses"></div>
  </section>

  <section>
    <h2>Export</h2>
    <button type="button" class="btn" onclick="window.location='/api/export/excel'">Export to Excel</button>
    <div class="muted" style="margin-top:8px;">Downloads an .xlsx with people, totals, net balances, expenses, and transfers.</div>
  </section>

</body>
</html>


